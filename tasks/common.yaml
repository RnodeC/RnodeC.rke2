---
- name: Set Defaults  
  include_tasks: defaults.yaml

- name: OS Config 
  include_tasks: os.yaml
  
- name: Establish rke2 Version 
  include_tasks: rke2_version.yaml 

- name: Setup rke2 Config Files 
  include_tasks: config_files.yaml
  
- name: Install rke2
  include_tasks: install.yaml

- block:
  - name: Fire rke2 service
    ansible.builtin.systemd:
      name: "rke2-{{ rke2_role }}"
      state: "{{ 'restarted' if (action == 'upgrade' or 'upgrade' in extra_tags | default([])) else 'started' }}"
      enabled: true
    delegate_to: "{{ item }}"
    become: true
    loop: "{{ play_hosts }}"
    run_once: true

  - name: Pause to ensure the service is stable
    ansible.builtin.pause:
      seconds: "{{ pause_time | default(30) }}"
    loop: "{{ play_hosts }}"
    run_once: true
    loop_control:
      index_var: loop_index
    when: (loop_index + 1) != play_hosts|length

  - name: Wait for rke2 server nodes to be Ready
    ansible.builtin.shell: "/var/lib/rancher/rke2/bin/kubectl --kubeconfig {{ rke2_server_kubeconfig }} get nodes | grep {{ ansible_hostname }}"
    args: 
      executable: /bin/bash
    changed_when: false 
    register: node_ready
    until: '" Ready " in node_ready.stdout'
    retries: 10
    delay: 30
    become: true
    when: rke2_role == 'server'

  - name: Write local-path-provisioner Manifest
    ansible.builtin.template: 
      src: "local-path-provisioner.yaml.j2"
      dest: "{{ rke2_manifests_dir }}"
      owner: root 
      group: root 
      mode: 0644
    when: rke2_local_storage and rke2_role == 'server'

  become: true 
