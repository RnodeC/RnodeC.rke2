---
- block:
  - name: Create rke2 config dir
    file:
      path: /etc/rancher/rke2
      state: directory
      owner: root
      group: root 
      mode: 0755 

  - name: Write rke2 config.yaml file 
    template:
      src: config.yaml.j2 
      dest: /etc/rancher/rke2/config.yaml 
      owner: root 
      group: root 
      mode: 0644

  - name: Write rke2 audit-policy.yaml file
    copy:
      src: audit-policy.yaml
      dest: /etc/rancher/rke2/audit-policy.yaml
      owner: root 
      group: root 
      mode: 0644
    when: rke2_role == 'server'
  become: true

- name: Ensure rke2_manifests_dir exists
  ansible.builtin.file:
    name: "{{ rke2_manifests_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  become: true

- block:
  - name: Ensure rke2_local_storage_path exists
    ansible.builtin.file:
      name: "{{ rke2_local_storage_path }}"
      state: directory
      owner: root
      group: root
      mode: 0777

  - name: Write local-path-provisioner Manifest
    ansible.builtin.template: 
      src: "manifests/local-path-provisioner.yaml.j2"
      dest: "{{ rke2_manifests_dir }}/local-path-provisioner.yaml"
      owner: root 
      group: root 
      mode: 0644
    when: rke2_role == 'server'
  become: true 
  when: rke2_local_storage | default(false) | bool

- name: Write rke2-ingress-nginx-config Manifest
  ansible.builtin.template: 
    src: "manifests/rke2-ingress-nginx-config.yaml.j2"
    dest: "{{ rke2_manifests_dir }}/rke2-ingress-nginx-config.yaml"
    owner: root 
    group: root 
    mode: 0644
  become: true
  when: rke2_nginx_tcp_services is defined or rke2_nginx_udp_services is defined